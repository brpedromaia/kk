#!/bin/bash

ingress_bootstrap() {

  kubectl apply --filename https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.0/deploy/static/provider/kind/deploy.yaml
  kubectl -n ingress-nginx patch deployment ingress-nginx-controller --type=json \
  -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--enable-ssl-passthrough"}]'
  kubectl wait --namespace ingress-nginx \
    --for=condition=ready pod \
    --selector=app.kubernetes.io/component=controller \
    --timeout=180s
}

 singlenode() { 
  if [ -z "$1" ];then
    echo -e "singlenode requires CLUSTER_NAME args.\nexample: kkind singlenode mycluster"
  else
    kind create cluster -n $1 && ingress_bootstrap
  fi
 }


 multinode() { 

  if [ -z "$1" ] | [ -z "$2" ];then
    echo -e "multinode requires CLUSTER_SIZE and CLUSTER_NAME args.\nexample: kkind multinode 3 mycluster"
  else
    yq -i 'del(.nodes[] | select(.role == "workers"))' /usr/local/kk/kind-config.yml

    for ((i = 1 ; i <= $1 ; i++ )); do
      yq -i ".nodes.$i.role = \"worker\"" /usr/local/kk/kind-config.yml
    done
    kind create cluster -n $2 --config /usr/local/kk/kind-config.yml && ingress_bootstrap
  fi
 }

get_clusters(){
 echo $(kind get clusters | tr "\n" " ")
}

delete() {
  kind delete cluster -n $1
}

$@
